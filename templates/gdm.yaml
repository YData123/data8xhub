resources:
{%- for name, cluster in config.clusters.items() %}
- type: container.v1.cluster
  name: {{ deployment }}-{{ name }}
  properties:
    zone: {{ cluster.zone }}
    cluster:
      name: {{ deployment }}-{{ name }}
      network: default
      initialClusterVersion:  1.9.2-gke.1
      addonsConfig:
        httpLoadBalancing:
          disabled: true
      legacyAbac:
        enabled: false
      nodePools:
        - initialNodeCount: {{ cluster.initialNodeCount }}
          name: default
          autoscaling:
            enabled: true
            minNodeCount: 2
            maxNodeCount: 100
          config:
            machineType: {{ cluster.machineType }}
            diskSizeGb: {{ cluster.bootDiskSizeGb }}
            imageType: ubuntu
            metadata:
              deployment: {{ deployment }}
              cluster: {{ name }}
            oauthScopes:
              - https://www.googleapis.com/auth/compute
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring
{%- endfor %}
{%- for name, fileserver in config.fileservers.items() %}
- type: compute.v1.disk
  name: {{ deployment }}-{{ name }}-data-disk
  properties:
    zone: {{ fileserver.zone }}
    sizeGb: {{ fileserver.dataDiskSizeGb }}
    type: https://www.googleapis.com/compute/v1/projects/{{ config.project }}/zones/{{ fileserver.zone }}/diskTypes/pd-ssd
- type: compute.v1.instance
  name: {{ deployment }}-{{ name }}
  properties:
    zone: {{ fileserver.zone }}
    machineType: https://www.googleapis.com/compute/v1/projects/{{ config.project }}/zones/{{ fileserver.zone }}/machineTypes/{{ fileserver.machineType }}
    metadata:
      items:
       - key: deployment
         value: {{ deployment }}
       - key: name
         value: "{{ name }}"
       - key: startup-script
         value: |
           #!/bin/bash
           CLONE_PATH=/var/lib/ansible
           sudo apt-get install --yes ansible git
           sudo git clone http://github.com/berkeley-dsep-infra/data8xhub ${CLONE_PATH}
           sudo ansible-playbook -c local -i localhost, ${CLONE_PATH}/ansible/playbook.yml
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        diskName: {{ deployment }}-{{ name }}-boot-disk
        sourceImage: https://www.googleapis.com/compute/v1/projects/ubuntu-os-cloud/global/images/family/ubuntu-1710
    - deviceName: {{ deployment }}-{{ name }}-data-disk
      type: PERSISTENT
      source: $(ref.{{ deployment }}-{{ name }}-data-disk.selfLink)
      autoDelete: false
    networkInterfaces:
    - network: https://www.googleapis.com/compute/v1/projects/{{ config.project }}/global/networks/default
      # Access Config required to give the instance a public IP address
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
{% endfor %}
