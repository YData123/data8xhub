jupyterhub:
  hub:
    concurrentSpawnLimit: 100
    extraVolumes:
    - name: csql-secret
      secret:
        secretName: csql-secret
    extraContainers:
    - name: cloudsql-proxy
      image: gcr.io/cloudsql-docker/gce-proxy:1.11
      command:
      - "/cloud_sql_proxy"
      - "-instances={{config.project}}:{{config.region}}:{{ deployment }}-db-instance=tcp:5432"
      - "-credential_file=/secrets/cloudsql/credentials.json"
      volumeMounts:
        - name: csql-secret
          mountPath: /secrets/cloudsql
          readOnly: true
    extraEnv:
      HUB_NAME: {{ name }}
      SHARDER_DB_USERNAME: {{ deployment }}-db-proxyuser
      SHARDER_DB_PASSWORD: {{ config.sql.password }}
      SHARDER_DB_NAME: {{ deployment }}-nfs-sharder-db
    extraConfig: |
      {{ files['sharder.py']|indent(6) }}

      {{ files['sharding-config.py']|indent(6) }}

      {{ files['hub-marker.py']|indent(6) }}

    extraConfigMap:
      deployment: {{ deployment|safe }}
      full-config: {{ config|jsonify|safe }}

  singleuser:
    schedulerStrategy: pack
    image:
      name: yuvipanda/data8x-user
      tag: v2
    storage:
      type: custom